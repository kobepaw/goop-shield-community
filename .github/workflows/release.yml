name: Release

on:
  push:
    tags:
      - "v*"
      - "!v*rc*"

permissions:
  contents: write    # for creating GH release
  id-token: write    # for trusted publishing
  packages: write    # for GHCR container publishing

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false   # never cancel a release in progress

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: kobepaw/goop-shield-community

jobs:
  test:
    name: Test gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !contains(github.ref, 'rc') }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - run: pytest tests/ -v

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test]
    environment: pypi
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4
      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.12"

      - name: Verify tag matches package version
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PKG_VERSION=$(python -c "exec(open('src/goop_shield/_version.py').read()); print(__version__)")
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag v$TAG_VERSION does not match package version $PKG_VERSION"
            exit 1
          fi

      - run: pip install build
      - run: python -m build

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: dist
          path: dist/

      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom
          pip install -e ".[server,cli]"
          cyclonedx-py environment -o sbom.json --format json

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: sbom
          path: sbom.json

      - uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # v1.13.0
        with:
          attestations: true

      - name: Generate changelog
        id: changelog
        run: |
          pip install git-cliff
          git-cliff --latest --strip header -o RELEASE_NOTES.md || echo "No conventional commits found" > RELEASE_NOTES.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release create "${{ github.ref_name }}" dist/* sbom.json --notes-file RELEASE_NOTES.md

  docker:
    name: Publish Container
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [publish]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130  # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9  # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract tag version
        id: meta
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Build and push multi-arch container
        uses: docker/build-push-action@263435318d21b8e681c14492fe198e19c816612b  # v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${{ steps.meta.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=https://github.com/kobepaw/goop-shield-community
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}

      - name: Sign container with cosign
        uses: sigstore/cosign-installer@3454372be43e8ddf55c6a5d02c0a8e0f76737b44  # v3
      - run: cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:v${{ steps.meta.outputs.version }}
